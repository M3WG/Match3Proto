<!DOCTYPE html>
<html>
  <head>
    <title>m3-prototype</title>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="../css/main.css" rel="stylesheet" type="text/css" />
    <link href="../css/app.css" rel="stylesheet" />
    <link href="../css/keyframes.css" rel="stylesheet" />
    <link href="../css/utility.css" rel="stylesheet" />
    <link href="../css/component/cell.css" rel="stylesheet" type="text/css" />
    <link href="../css/component/map.css" rel="stylesheet" type="text/css" />
    <link href="../css/component/picker.css" rel="stylesheet" type="text/css" />
    <link href="../css/component/score.css" rel="stylesheet" type="text/css" />

    <!--<script src="./lib/.js"></script>-->

    <script src="../js/main.js"></script>

    <!--<script src="../js/utility/.js"></script>-->
    <script src="../js/utility/array.js"></script>
    <script src="../js/utility/fn.js"></script>
    <script src="../js/utility/matrix.js"></script>
    <script src="../js/utility/pubsub.js"></script>

    <script src="../js/m3.js"></script>

    <!--<script src="../js/m3/app/.js"></script>-->
    <script src="../js/m3/app.js"></script>

    <!--<script src="../js/m3/component/.js"></script>-->
    <script src="../js/m3/component/base.js"></script>
    <script src="../js/m3/component/cell.js"></script>
    <script src="../js/m3/component/map.js"></script>
    <script src="../js/m3/component/picker.js"></script>
    <script src="../js/m3/component/score.js"></script>

    <!--<script src="../js/m3/config/.js"></script>-->
    <script src="../js/m3/config/claimTypes.js"></script>
    <script src="../js/m3/config/tiles.js"></script>

    <!--<script src="../js/m3/model/.js"></script>-->
    <script src="../js/m3/model/base.js"></script>
    <script src="../js/m3/model/action.js"></script>
    <script src="../js/m3/model/bank.js"></script>
    <script src="../js/m3/model/cell.js"></script>
    <script src="../js/m3/model/claim.js"></script>
    <script src="../js/m3/model/claimType.js"></script>
    <script src="../js/m3/model/game.js"></script>
    <script src="../js/m3/model/hand.js"></script>
    <script src="../js/m3/model/map.js"></script>
    <script src="../js/m3/model/mapSlice.js"></script>
    <script src="../js/m3/model/path.js"></script>
    <script src="../js/m3/model/player.js"></script>
    <script src="../js/m3/model/prefab.js"></script>
    <script src="../js/m3/model/round.js"></script>
    <script src="../js/m3/model/tile.js"></script>
    <script src="../js/m3/model/turn.js"></script>
    <script src="../js/m3/model/user.js"></script>

    <!--<script src="../js/m3/utility/.js"></script>-->
    <script src="../js/m3/utility/action.js"></script>
    <script src="../js/m3/utility/claim.js"></script>
    <script src="../js/m3/utility/crawler.js"></script>
    <script src="../js/m3/utility/map.js"></script>
    <script src="../js/m3/utility/match.js"></script>
  </head>
  <body>

    <div class="m3-a-topBar"></div>
    <div class="m3-a-bottomBar"></div>

    <script>
      const bottomBar = document.querySelector('.m3-a-bottomBar'),
        topBar = document.querySelector('.m3-a-topBar')

      const players = [
        m3.model.player.create(),
        m3.model.player.create(),
        m3.model.player.create(),
      ]

      const claimStore = []

      const map = m3.model.map.create({
        height: 50,
        width: 50,
      })

      const game = m3.model.game.create({
        map,
        player: players,
      })

      const mapComponent = m3.component.map.create({
        model: map,
      }, document.body).attach()

      // Create picker component
      const pickerOptions = m3.model.tile.getAll().filter((tile) => {
        // XXX: Hide space
        return tile.getId() != 0
      }).sort((a, b) => {
        return a.getName().localeCompare(b.getName())
      }).map((tile) => ({
        label: tile.getIcon() + ' ' + tile.getName(),
        value: tile.getId(),
      }))

      const pickerComponent = m3.component.picker.create({
        option: pickerOptions,
      }, bottomBar).attach()

      // Map generation
      m3.utility.map.randomize(map)

      // Create initial round/turn
      game.createRound().createTurn({
        player: game.getPlayer(0),
      })

      // Create score components
      const scoreComponents = players.map((player) => {
        const container = document.createElement('div')
        container.className = 'm3-a-score--score'
        topBar.appendChild(container)

        m3.component.score.create({model: player}, container)
      })

      // Create start locations
      const createStartLocation = (player, x, y) => {
        const cell = map.getCell(x, y)

        const claim = m3.model.claim.create({
          cell: [cell],
          player,
          type: m3.model.claimType.get(6),
        })

        cell.setTile(7).setClaim(claim)

        claimStore.push(claim)

        return claim
      }

      createStartLocation(players[0], 10, 10)
      createStartLocation(players[1], 40, 10)
      createStartLocation(players[2], 10, 40)

      claimStore.forEach((claim) => {
        claim.getFogShape().forEach((cell) => cell.setFog(false))
      })

      // Click event handlers
      mapComponent.getCells().forEach(function subscribeClick(cell) {
        cell.on('click', function onClick() {
          const model = cell.getModel(),
            pickerValue = pickerComponent.getValue(),
            round = game.getCurrentRound(),
            tile = m3.model.tile.get(pickerValue),
            turn = round.getCurrentTurn()

          const options = {
            cell: model,
            tile,
          }

          if (!m3.utility.action.validate(options)) {
            return;
          }

          const match = m3.utility.match(options)

          if (match) {
            match.player = round.getPlayer()

            const claim = m3.model.claim.create(match),
              score = claim.type.getScore()

            turn.player.incrementScore(score)

            claim.getFogShape().forEach((cell) => cell.setFog(false))

            claimStore.push(claim)
          }

          const action = turn.createAction(options),
            isTurnEnd = turn.getActionCount() >= 3

          if (isTurnEnd) {
            const isRoundEnd = isTurnEnd && round.getTurnCount() >= game.getPlayerCount()

            if (isRoundEnd) {
              // TODO: Check game end condition
              game.createRound().createTurn({
                player: game.getPlayer(0),
              })
            } else {
              round.createTurn({
                player: game.getPlayer(round.getTurnCount())
              })
            }

            alert('Your turn is over')
          }

          model.setTile(tile)
        })
      })
    </script>

    <style>
      body {
        padding: 3em 0;
      }

      .m3-a-bottomBar {
        background-color: rgba(0, 0, 0, 0.5);
        bottom: 0;
        display: flex;
        justify-content: space-between;
        left: 0;
        position: fixed;
        width: 100%;
        z-index: 2;
      }

      .m3-a-topBar {
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: space-between;
        left: 0;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 2;
      }
    </style>

  </body>
</html>
